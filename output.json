[
  [
    "macro",
    [
      "def-wasm-operator",
      "op",
      "wasm-fn",
      "arg-type",
      "return-type"
    ],
    [
      "pub",
      "fn",
      [
        "$op",
        [
          "typed-parameter",
          "left",
          "$arg-type"
        ],
        [
          "typed-parameter",
          "right",
          "$arg-type"
        ]
      ],
      "->",
      "$return-type",
      [
        "binaryen-mod",
        [
          "$arg-type",
          "$wasm-fn"
        ],
        [
          "left",
          "right"
        ]
      ]
    ]
  ],
  [
    "macro",
    [
      "pub",
      "&body"
    ],
    "$&body",
    [
      "export",
      [
        "$",
        "extract",
        "&body",
        1
      ]
    ]
  ],
  [
    "macro",
    [
      "let",
      "&body"
    ],
    [
      "$@",
      "block",
      [
        "define",
        "equals-expr",
        [
          "extract",
          "&body",
          0
        ]
      ],
      [
        "array",
        "\"define\"",
        [
          "extract",
          "equals-expr",
          1
        ],
        [
          "extract",
          "equals-expr",
          2
        ]
      ]
    ]
  ],
  [
    "macro",
    [
      "var",
      "&body"
    ],
    [
      "$@",
      "block",
      [
        "define",
        "equals-expr",
        [
          "extract",
          "&body",
          0
        ]
      ],
      [
        "array",
        "\"define-mut\"",
        [
          "extract",
          "equals-expr",
          1
        ],
        [
          "extract",
          "equals-expr",
          2
        ]
      ]
    ]
  ],
  [
    "macro",
    [
      "lambda",
      "&body"
    ],
    [
      "lambda-expr",
      [
        "quote",
        "$&body"
      ]
    ]
  ],
  [
    "macro",
    [
      "'=>'",
      "&body"
    ],
    [
      "lambda-expr",
      [
        "quote",
        [
          "$",
          "macro-expand",
          "&body"
        ]
      ]
    ]
  ],
  [
    "macro",
    [
      "'<|'",
      "&body"
    ],
    [
      "$@",
      "block",
      "&body"
    ]
  ],
  [
    "macro",
    [
      "fn",
      "&body"
    ],
    [
      "$@",
      "block",
      [
        "let",
        [
          "=",
          "definitions",
          [
            "block",
            [
              "extract",
              "&body",
              0
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "identifier",
          [
            "block",
            [
              "extract",
              "definitions",
              0
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "params",
          [
            "block",
            [
              "concat",
              [
                "array",
                "\"parameters\""
              ],
              [
                "map",
                [
                  "slice",
                  "definitions",
                  1
                ],
                [
                  "=>",
                  [
                    "expr"
                  ],
                  [
                    "block",
                    [
                      "let",
                      [
                        "=",
                        "param-identifier-index",
                        [
                          "block",
                          [
                            "if",
                            [
                              "==",
                              [
                                "length",
                                "expr"
                              ],
                              3
                            ],
                            1,
                            2
                          ]
                        ]
                      ]
                    ],
                    [
                      "let",
                      [
                        "=",
                        "param-identifier",
                        [
                          "block",
                          [
                            "extract",
                            "expr",
                            "param-identifier-index"
                          ]
                        ]
                      ]
                    ],
                    [
                      "let",
                      [
                        "=",
                        "type",
                        [
                          "block",
                          [
                            "extract",
                            "expr",
                            [
                              "+",
                              "param-identifier-index",
                              1
                            ]
                          ]
                        ]
                      ]
                    ],
                    [
                      "array",
                      "param-identifier",
                      "type"
                    ]
                  ]
                ]
              ]
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "type-arrow-index",
          [
            "block",
            [
              "if",
              [
                "==",
                [
                  "extract",
                  "&body",
                  1
                ],
                "\"->\""
              ],
              1,
              [
                "if",
                [
                  "==",
                  [
                    "extract",
                    "&body",
                    2
                  ],
                  "\"->\""
                ],
                2,
                -1
              ]
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "return-type",
          [
            "block",
            [
              "array",
              "\"return-type\"",
              [
                "if",
                [
                  ">",
                  "type-arrow-index",
                  -1
                ],
                [
                  "extract",
                  "&body",
                  [
                    "+",
                    "type-arrow-index",
                    1
                  ]
                ],
                [
                  "array"
                ]
              ]
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "expressions",
          [
            "block",
            [
              "<|",
              "macro-expand",
              [
                "block",
                [
                  "if",
                  [
                    ">",
                    "type-arrow-index",
                    -1
                  ],
                  [
                    "slice",
                    "&body",
                    [
                      "+",
                      "type-arrow-index",
                      2
                    ]
                  ],
                  [
                    "slice",
                    "&body",
                    1
                  ]
                ]
              ]
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "extract-variables",
          [
            "block",
            [
              "=>",
              [
                "exprs"
              ],
              [
                "block",
                [
                  "reduce",
                  "exprs",
                  [
                    "array"
                  ],
                  [
                    "=>",
                    [
                      "vars",
                      "expr"
                    ],
                    [
                      "block",
                      [
                        "if",
                        [
                          [
                            "is-list",
                            "expr"
                          ]
                        ],
                        [
                          "if",
                          [
                            "==",
                            [
                              "or",
                              [
                                "==",
                                [
                                  "extract",
                                  "expr",
                                  0
                                ],
                                "\"define-mut\""
                              ],
                              [
                                "extract",
                                "expr",
                                0
                              ]
                            ],
                            "\"define\""
                          ],
                          [
                            "block",
                            [
                              "push",
                              "vars",
                              [
                                "array",
                                [
                                  "extract",
                                  "expr",
                                  1
                                ],
                                [
                                  "extract",
                                  "expr",
                                  2
                                ]
                              ]
                            ],
                            "vars"
                          ],
                          [
                            "concat",
                            "vars",
                            [
                              "extract-variables",
                              "expr"
                            ]
                          ]
                        ],
                        "vars"
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ]
        ]
      ],
      [
        "let",
        [
          "=",
          "variables",
          [
            "block",
            [
              "concat",
              [
                "array",
                "variables"
              ],
              [
                "extract-variables",
                "expressions"
              ]
            ]
          ]
        ]
      ],
      [
        "array",
        "\"define-function\"",
        "identifier",
        "params",
        "variables",
        "return-type",
        [
          "concat",
          [
            "array",
            "\"block\""
          ],
          "expressions"
        ]
      ]
    ]
  ],
  [
    "def-wasm-operator",
    "'<'",
    "lt_s",
    "i32",
    "i32"
  ],
  [
    "def-wasm-operator",
    "'-'",
    "sub",
    "i32",
    "i32"
  ],
  [
    "def-wasm-operator",
    "'+'",
    "add",
    "i32",
    "i32"
  ],
  [
    "def-wasm-operator",
    "'<'",
    "lt",
    "f32",
    "i32"
  ],
  [
    "def-wasm-operator",
    "'-'",
    "sub",
    "f32",
    "f32"
  ],
  [
    "def-wasm-operator",
    "'+'",
    "add",
    "f32",
    "f32"
  ]
]
