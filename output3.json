[
  "macro",
  ["fn", "&body"],
  ["define", "definitions", ["block", ["extract", "&body", 0]]],
  ["define", "identifier", ["block", ["extract", "definitions", 0]]],
  [
    "define",
    "params",
    [
      "block",
      [
        "concat",
        ["array", "\"parameters\""],
        [
          "map",
          ["slice", "definitions", 1],
          [
            "lambda",
            [
              ["expr"],
              [
                "block",
                [
                  "let",
                  [
                    "=",
                    "param-identifier-index",
                    ["block", ["if", ["==", ["length", "expr"], 3], 1, 2]]
                  ]
                ],
                [
                  "let",
                  [
                    "=",
                    "param-identifier",
                    ["block", ["extract", "expr", "param-identifier-index"]]
                  ]
                ],
                [
                  "let",
                  [
                    "=",
                    "type",
                    [
                      "block",
                      ["extract", "expr", ["+", "param-identifier-index", 1]]
                    ]
                  ]
                ],
                ["`", "param-identifier", "$type"]
              ]
            ]
          ]
        ]
      ]
    ]
  ],
  [
    "define",
    "type-arrow-index",
    [
      "block",
      [
        "if",
        ["==", ["extract", "&body", 1], "\"->\""],
        1,
        ["if", ["==", ["extract", "&body", 2], "\"->\""], 2, -1]
      ]
    ]
  ],
  [
    "define",
    "return-type",
    [
      "block",
      [
        "quote",
        "return-type",
        [
          "$",
          "if",
          [">", "type-arrow-index", -1],
          ["extract", "&body", ["+", "type-arrow-index", 1]],
          ["quote"]
        ]
      ]
    ]
  ],
  [
    "define",
    "expressions",
    [
      "block",
      [
        "macro-expand",
        [
          "if",
          [">", "type-arrow-index", -1],
          ["slice", "&body", ["+", "type-arrow-index", 2]],
          ["slice", "&body", 1]
        ]
      ]
    ]
  ],
  [
    "define",
    "extract-variables",
    [
      "block",
      [
        "lambda",
        [
          ["exprs"],
          [
            "block",
            [
              "reduce",
              "exprs",
              ["array"],
              [
                "=>",
                ["vars", "expr"],
                [
                  "block",
                  [
                    "if",
                    ["is-list", "expr"],
                    [
                      "if",
                      [
                        "==",
                        [
                          "or",
                          ["==", ["extract", "expr", 0], "\"define-mut\""],
                          ["extract", "expr", 0]
                        ],
                        "\"define\""
                      ],
                      [
                        "block",
                        [
                          "push",
                          "vars",
                          [
                            "array",
                            [
                              ["extract", "expr", 1],
                              ["extract", "expr", 2]
                            ]
                          ]
                        ],
                        "vars"
                      ],
                      ["concat", "vars", ["extract-variables", "expr"]]
                    ],
                    "vars"
                  ]
                ]
              ]
            ]
          ]
        ]
      ]
    ]
  ],
  [
    "define",
    "variables",
    [
      "block",
      ["concat", ["array", "variables"], ["extract-variables", "expressions"]]
    ]
  ],
  [
    "quote",
    "define-function",
    "$identifier",
    "$params",
    "$variables",
    "$return-type",
    ["$", ["concat", ["array", "\"block\""], "expressions"]]
  ]
]
